{% import "macros/admin_macros.html" as admin_macros %}
{% import "macros/basic_macros.html" as basic_macros %}
{% import "macros/common_macros.html" as common_macros %}

{% extends "base.html" %}

{% block body_class %}page-admin-orders{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/table.css') }}?v={{ get_setting('version') }}">
{% endblock head %}

{% block content %}

{% include "admin/menu.html" %}

{{ basic_macros.page_title(title) }}

{# Select active, completed, order_history #}
<form method="GET" action="/admin/orders">
    <select name="status" id="status">
        <option title="Aktive bestillinger" value="active" {% if status=='active' %}selected{% endif %}>Aktive
            bestillinger</option>
        <option title="Materiale som er afsluttet, men som ikke er i magasin" value="completed" {% if
            status=='completed' %}selected{% endif %}>Afsluttet materiale</option>
        <option title="Historik over afsluttede bestillinger" value="order_history" {% if status=='order_history' %}selected{%
            endif %}>Historik</option>
    </select>
</form>

{% if orders|length == 0 %}
    {% if status == 'active' %}
        <p>Der er ingen bestillinger at vise</p>
    {% elif status == 'completed' %}
        <p>Der er ingen afsluttede bestillinger at vise</p>
    {% elif status == 'order_history' %}
        <p>Der er ingen historik at vise</p>
    {% endif %}
{% else %}

<div class="table-wrapper">
<table>
    <thead>
        <tr>
            <th>Materiale</th>
            <th>Lokation</th>
            <th>Handling</th>
            <th>E-mail</th>
            <th>Brugernavn</th>
            <th>Bruger status</th>
            <th>Opdateret</th>
            <th class="td-deadline">Deadline</th>
            <th class="td-queue" title="Antal brugere som står i kø">I Kø</th>  
        </tr>
    </thead>
    <tbody>
        {% for order in orders %}
        <tr>
            <td>
                <a title="{{ order.label }}" href="/records/{{order.record_id}}">{{ order.label }}</a>
            </td>
            <td>
                {% if order.allow_location_change %}
                {% set location_change_disabled = "" %}
                {% set title = "" %}
                {% else %}
                {% set location_change_disabled = "disabled" %}
                {% set title = "Du har ikke ændre lokation, da materialet er i Læsesalen og en bruger har rettighed til
at benytte det. Du må først slette eller afslutte den aktive bestilling, før du kan ændre lokation." %}
                {% endif %}

                <select {{ location_change_disabled }} name="location" class="location" data-id="{{ order.order_id }}"
                    title="{{ title }}">
                    {% for key, value in locations.items() %}
                    <option value="{{ key }}" data-initial="{{ key }}" {% if order.location==key %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <span>
                    <a href="/admin/orders/{{order.order_id}}/edit">Rediger</a>

                    {% if not order.user_actions_deactivated %}
                    <span class="complete-order">
                        <a data-id="{{order.order_id}}" data-action="completed"
                            title="Brugeren er færdig med bestillingen" href="#">Afslut</a>
                    </span>
                    {% endif %}
                </span>
            </td>
            <td>{{ order.user_email }}</td>
            <td>{{ order.user_display_name }}</td>
            <td>{{ order.user_status_human }}</td>

            <td>{{ order.updated_at }}</td>
            {% if order.deadline %}
            <td class="td-deadline">{{ order.deadline }}</td>
            {% else %}
            <td>Ikke angivet</td>
            {% endif %}
            <td class="td-queue">{{ order.count }}</td>
        </tr>
        {% if order.resources_str %}
        <tr>
            <td class="resources" colspan="8">{{ order.resources_str }}</td> 
        </tr>
        {% endif %}
        <tr>
            <td class="record_and_types" colspan="8">{{ order.record_and_types_str | safe }}</td>
        </tr>
        {% endfor %}
        <tr>
            <td></td>
            <td><a href="#" class="update-locations">Opdatér</a></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </tbody>
</table>
</div>
{% endif %}
<style>

    .container-medium {
        width: 100%;
    }

    a[disabled] {
        pointer-events: none;
    }

    /*
    input,
    button,
    textarea,
    */

    select {
        color: var(--form-text);
        background-color: var(--background);
        margin-right: 6px;
        margin-bottom: 6px;
        padding: 2px;
        border: unset;
        border-radius: unset;
        outline: unset;
        font-family: unset;
        font-size: inherit;
    }


    tbody tr:nth-child(even) {
        background-color: unset;
    }

    td a {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: table-cell;
        max-width: 180px;
    }

    td,
    th {
        max-width: 60px;
    }

    td.resources {
        background-color: #fbfbfb;
        font-size: 0.9em;
    }
</style>
<div class="loadingspinner hidden"></div>
<script type="module">
    import { asyncLogError } from "/static/js/error.js";
    import { Requests } from "/static/js/requests.js";
    import { Flash } from "/static/js/flash.js";
    import { StatusesUser } from '/static/js/orders.js';

    const spinner = document.querySelector('.loadingspinner');

    /**
     * Handle FINISHED (afsluttet) and DELETED (slettet) clicks
     */
    async function handleUserStatusClick(event) {

        event.preventDefault();
        Flash.clearMessages();
        spinner.classList.toggle('hidden');

        try {

            const element = event.target;
            const action = element.dataset.action;

            if (action == 'completed') {
                if (!confirm('Er du sikker på at brugeren har afsluttet denne bestilling?')) {
                    return;
                }
            } else {
                if (!confirm('Er du sikker på at du vil slette denne bestilling?')) {
                    return;
                }
            }

            let data = {};
            if (action === 'completed') {
                data = {
                    'user_status': StatusesUser.COMPLETED
                }
            } else {
                data = {
                    'user_status': StatusesUser.DELETED
                }
            }

            const url = '/admin/orders/patch/' + element.dataset.id;
            const res = await Requests.asyncPostJson(url, data);

            if (res.error) {
                Flash.setMessage(res.message, 'error');
            } else {
                window.location.reload();
            }

        } catch (e) {
            Flash.setMessage(res.message, 'error');
            await asyncLogError('/error/log', e.stack);
        } finally {
            spinner.classList.toggle('hidden');
        }
    }

    /**
     * eventListener on handleUserStatusClick on ".complete-order"
     */
    document.querySelectorAll('.complete-order > *').forEach(element => {
        element.addEventListener('click', handleUserStatusClick);
    });

    const locationElements = document.querySelectorAll('.location');

    // Get initial vales in order to only update changed values
    const initialLocationValues = [];
    locationElements.forEach(element => {
        const selected = element.options[element.selectedIndex].value;
        initialLocationValues.push(selected);
    });

    const updateLocations = document.querySelector('.update-locations');
    if (updateLocations) {
        updateLocations.addEventListener('click', async function () {
            const data = [];
    
            // Add to data values that have changed compared to initial values
            locationElements.forEach((element, index) => {
                const selected = element.options[element.selectedIndex].value;
                if (selected !== initialLocationValues[index]) {
                    data.push({
                        'order_id': element.dataset.id,
                        'location': selected
                    });
                }
            });
    
            const url = '/admin/orders/patch';
            spinner.classList.toggle('hidden');
    
            try {
                const res = await Requests.asyncPostJson(url, data);
                
                // Redirect to same page to update view
                window.location.reload();
            } catch (e) {
                Flash.setMessage(res.message, 'error');
                await asyncLogError('/error/log', e.stack);
            } finally {
                spinner.classList.toggle('hidden');
            }
        });
    }
    
    /**
     * handles drop down to select "Aktive bestillinger", "Afsluttet materialer"
    */
    const status = document.getElementById('status');
    status.addEventListener('change', function () {
        window.location.href = '/admin/orders?status=' + status.value;
    });

</script>
{% endblock content %}