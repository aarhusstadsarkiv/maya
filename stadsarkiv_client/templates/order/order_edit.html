{% import "macros/admin_macros.html" as admin_macros %}
{% import "macros/basic_macros.html" as basic_macros %}

{% extends "base.html" %}

{% block body_class %}page-admin-orders-edit{% endblock %}

{% block head %}

<link rel="stylesheet" href="{{ url_for('static', path='/css/table.css') }}?v={{ get_setting('version') }}">
{% endblock head %}

{% block content %}

{% include "admin/menu.html" %}

{{ basic_macros.page_title(title) }}

<div class="record-section">
    <div class="record-main">

        <div class="record-content">
            <div class="label">E-mail</div>
            <div class="content">{{ order.user_email}}</div>
        </div>

        <div class="record-content">
            <div class="label">Navn</div>
            <div class="content">{{ order.user_display_name}}</div>
        </div>

        <div class="record-content">
            <div class="label">Materiale</div>
            <div class="content">
                <a href="/records/{{ order.record_id}}">{{ order.label }}</a>
            </div>
        </div>

        <div class="record-content">
            <div class="label">Materiale ID </div>
            <div class="content">{{ order.record_id}}</div>
        </div>

        <div class="record-content">
            <div class="label">Status</div>
            <div class="content">{{ order.status }}</div>
        </div>

        <div class="record-content">
            <div class="label">Oprettet</div>
            <div class="content">{{ order.created_at }}</div>
        </div>

        <div class="record-content">
            <div class="label">Opdateret</div>
            <div class="content">{{ order.modified_at }}</div>
        </div>
        <hr>
    </div>
</div>
<div class="loadingspinner hidden"></div>

<form method="post" action="/admin/orders/{{ order.order_id }}">
    <select name="status" id="status">
        {% for key, value in statuses.items() %}
        <option value="{{ key }}" {% if order.status==key %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
    </select>
</form>
<script type="module">
    import { asyncLogError } from "/static/js/error.js";
    import { Requests } from "/static/js/requests.js";
    import { Flash } from "/static/js/flash.js";

    const spinner = document.querySelector('.loadingspinner');
    const statusElem = document.getElementById('status');

    // on submit change status
    statusElem.addEventListener("change", async function (event) {

        alert('hello world');
        return;

        event.preventDefault();
        Flash.clearMessages();
        spinner.classList.toggle('hidden');

        try {

            // Get URL from form action
            const form = document.querySelector('form');
            const url = form.action;
            const formData = new FormData(form);
            const res = await Requests.asyncPost(url, formData);

            if (res.error) {
                console.log(res.message);
                Flash.setMessage(res.message, 'error');
            } else {
                window.location.href = url;
            }

        } catch (e) {
            Flash.setMessage(res.message, 'error');
            await asyncLogError('/error/log', e.stack);
        } finally {
            spinner.classList.toggle('hidden');
        }
    });


</script>

<pre>{{ to_json(order) }}</pre>

<style>

</style>


{% endblock content %}