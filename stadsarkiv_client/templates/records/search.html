{% extends "base.html" %}

{% block content %}
{% include "includes/main_title.html" %}
{% set truncate_summary = 300 %}
{% set record_search_url = "/records-search" %}

{% macro _parse_facets(facets, top_level_key, facets_transformed) %}
<ul>
    {% for facet in facets %}
    <li>
        {% set facet_id = facet["id"] %}
        {% set count = facets_transformed[top_level_key][facet_id] %}

        {% if count %}
            {% if 'children' in facet %}
            <details>
                <summary>
                    <a href="{{ record_search_url }}?{{ query_str}}{{ top_level_key }}={{ facet['id'] }}">{{ facet['label'] }} ({{count }})</a>
                </summary>
                {{ _parse_facets(facet['children'], top_level_key, facets_transformed) }}
            </details>
            {% else %}
            <a href="{{ record_search_url }}?{{ query_str }}{{ top_level_key }}={{ facet['id'] }}">{{ facet['label'] }} ({{count }})</a>
            {% endif %}
        {% endif %}

    </li>
    {% endfor %}
</ul>
{% endmacro %}

{% macro parse_top_level_facets(facets, facets_transformed) %}
<div class="facets">
    
<ul>
    {% for top_level_key, top_level_value in facets.items() %}
    <li>
        <details>
            <summary>
                <a href="{{ record_search_url }}">{{ top_level_value['label'] }}</a>
            </summary>
            {{ _parse_facets(top_level_value['content'], top_level_key, facets_transformed) }}
        </details>
    </li>
    {% endfor %}
</ul>
</div>
{% endmacro %}


{% macro parse_search_form() %}
<form method="GET" action="{{ url_for('records_search')}}">
    {% for key, value in query_params %}
    <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
    <input type="text" name="q" placeholder="{{ translate('Search') }}" aria-label="{{ translate('search') }}"
        value="{{ q }}">
    <button type="submit" class="contrast">{{ translate('Search') }}</button>
</form>
{% endmacro %}

{% macro parse_search_title(result) %}
{% if result.label %}
<div class="summary">{{ result.label|truncate(truncate_summary) }}</div>
{% endif %}
{% if result.summary %}
<div class="summary">{{ result.summary|truncate(truncate_summary) }}</div>
{% endif %}
{% endmacro %}

{% macro parse_record_content(label, content) %}
{% if content %}
<div class="record-content" style="padding-top: 0.2em; margin-bottom: 0.2em">
    <div class="label" style="width: 6em;">
        <strong>{{ label }}</strong>
    </div>
    <div class="search-content">
        {{ content }}
    </div>
</div>
{% endif %}
{% endmacro %}

{% macro parse_pagination (size, total) %}
{% if not request.query_params.get('start') %}
{% set start = 0 %}
{% else %}
{% set start = request.query_params.get('start') | int %}
{% endif %}

{# start is where to start, e.g. 100, size is how many to show, e.g. 10, total is the total number of results, e.g. 1000 #}
<div class="pagination">
    {% if start > 0 %}
    <a href="?q={{ q }}&start={{ start - size }}&size={{ size }}">{{ translate('Previous') }}</a>
    {% endif %}
    {% if start + size < total %}
    <a href="?q={{ q }}&start={{ start + size }}&size={{ size }}">{{ translate('Next') }}</a>
    {% endif %}
</div>
{% endmacro %}

{% macro parse_search_results(records) %}
<div class="search-results">

    {{ parse_pagination(records.size, records.total) }}

    {% for result in records.result %}
    {% set serie = None %}
    {% if result.series is iterable %}
    {% set serie = result.series | last %}
    {% endif %}
    
    <div class="search-result">
        
        <a class="search-link" href="/records/{{ result.id }}">
                    
            {{ parse_search_title(result) }}
            {{ parse_record_content('Skaber', result.collectors_label) }}
            {# parse_record_content('Samling', result.collectors_label) #}
            {% if serie %}
            {{ parse_record_content('Serie', serie) }}
            {% endif %}

        </a>
    </div>
    {% endfor %}
</div>
{% endmacro %}

{{ parse_top_level_facets(facets, facets_transformed) }}
{{ parse_search_form() }}
{{ parse_search_results(records) }}

<pre>
    {{ to_json(records) }}
</pre>

{% endblock content %}