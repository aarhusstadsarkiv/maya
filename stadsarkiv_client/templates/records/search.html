{% extends "base.html" %}

{% block content %}
{% include "includes/main_title.html" %}
{% set truncate_summary = 300 %}
{% set search_base_url = "/records-search" %}


{% macro parse_facet_link(top_level_key, facet) %}

{% if facet["checked"] %}
{{ facet['label'] }} ({{ facet["count"] }})
{% else %}
<a href="{{ search_base_url }}?{{ facet['search_query'] }}">{{ facet['label'] }} ({{ facet["count"] }})</a>
{% endif %}

{% endmacro %}


{% macro parse_facets(top_level_key, facets_content) %}
<ul>
    {% for facet in facets_content %}
    <li>
        
        {% if 'children' in facet and facet["count"] %}
        <details>
            <summary>
                {{ parse_facet_link(top_level_key, facet) }}
            </summary>
            {{ parse_facets(top_level_key, facet['children'] ) }}
        </details>
        {% else %}
            {% if facet["count"] %}
            {{ parse_facet_link(top_level_key, facet) }}
            {% endif %}
        {% endif %}


    </li>
    {% endfor %}
</ul>
{% endmacro %}

{% macro parse_top_level_facets(facets) %}
<div class="facets">  
<ul>
    {% for top_level_key, top_level_value in facets.items() %}
    <li>
        <details>
            <summary>
                {{ top_level_value['label'] }}
            </summary>
            {{ parse_facets(top_level_key, top_level_value['content']) }}
        </details>
    </li>
    {% endfor %}
</ul>
</div>
{% endmacro %}


{% macro parse_search_form() %}
<form method="GET" action="{{ url_for('records_search')}}">
    {% for key, value in query_params %}
    <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
    <input type="text" name="q" placeholder="{{ translate('Search') }}" aria-label="{{ translate('search') }}"
        value="{{ q }}">
    <button type="submit" class="contrast">{{ translate('Search') }}</button>
</form>
{% endmacro %}

{% macro parse_search_title(result) %}
{% if result.label %}
<div class="summary">{{ result.label|truncate(truncate_summary) }}</div>
{% endif %}
{% if result.summary %}
<div class="summary">{{ result.summary|truncate(truncate_summary) }}</div>
{% endif %}
{% endmacro %}

{% macro parse_record_content(label, content) %}
{% if content %}
<div class="record-content" style="padding-top: 0.2em; margin-bottom: 0.2em">
    <div class="label" style="width: 6em;">
        <strong>{{ label }}</strong>
    </div>
    <div class="search-content">
        {{ content }}
    </div>
</div>
{% endif %}
{% endmacro %}

{% macro parse_pagination (size, total) %}
{% if not request.query_params.get('start') %}
{% set start = 0 %}
{% else %}
{% set start = request.query_params.get('start') | int %}
{% endif %}

{# start is where to start, e.g. 100, size is how many to show, e.g. 10, total is the total number of results, e.g. 1000 #}
<div class="pagination">
    {% if start > 0 %}
    <a href="?q={{ q }}&start={{ start - size }}&size={{ size }}">{{ translate('Previous') }}</a>
    {% endif %}
    {% if start + size < total %}
    <a href="?q={{ q }}&start={{ start + size }}&size={{ size }}">{{ translate('Next') }}</a>
    {% endif %}
</div>
{% endmacro %}

{% macro parse_search_results(records) %}
<div class="search-results">

    {{ parse_pagination(records.size, records.total) }}

    {% for result in records.result %}
    {% set serie = None %}
    {% if result.series is iterable %}
    {% set serie = result.series | last %}
    {% endif %}
    
    <div class="search-result">
        
        <a class="search-link" href="/records/{{ result.id }}">
                    
            {{ parse_search_title(result) }}
            {{ parse_record_content('Skaber', result.collectors_label) }}
            {% if serie %}
            {{ parse_record_content('Serie', serie) }}
            {% endif %}

        </a>
    </div>
    {% endfor %}
</div>
{% endmacro %}

{{ parse_top_level_facets(facets) }}
{{ parse_search_form() }}
{{ parse_search_results(records) }}

<pre>
    {{ to_json(facets) }}
</pre>

{% endblock content %}