{% extends "search.html" %}

{% set truncate_summary = 300 %}
{% set search_base_url = get_setting('search_base_url') %}

{% macro parse_facets_filters(facets_filters) %}
<ul>
    {% for facet in facets_filters %}
    <li>
        <a class="remove" href="{{ search_base_url }}?{{ facet['remove_query'] }}">{{ translate('Remove facet') }}</a>
        <span>{{ facet['checked_label'] }}</span>
    </li>
    {% endfor %}
</ul>
{% endmacro %}

{% macro parse_facet_link(top_level_key, facet) %}
{% if facet["checked"] %}
{{ facet['label'] }} ({{ facet["count"] }}) <span class="disabled">({{ translate('Selected') }})</span>
{% elif facet["count"] == 0 %}
{{ facet['label'] }} ({{ facet["count"] }}) <span class="disabled"></span>
{% else %}
<a href="{{ search_base_url }}?{{ facet['search_query'] }}">{{ facet['label'] }} ({{ facet["count"] }})</a>
{% endif %}
{% endmacro %}

{% macro parse_facets(top_level_key, facets_content) %}
<ul>
    {% for facet in facets_content %}
    <li>
        {% if 'children' in facet and facet["count"] %}
        <details data-id="{{ facet['id'] }}">
            <summary>
                {{ parse_facet_link(top_level_key, facet) }}
            </summary>
            {{ parse_facets(top_level_key, facet['children'] ) }}
        </details>
        {% else %}
        <details data-id="{{ facet['id'] }}">
            <summary class="closed">
                {{ parse_facet_link(top_level_key, facet) }}
            </summary>
        </details>
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endmacro %}

{% macro parse_top_level_facets(facets) %}
<div class="facets">
    <ul>
        {% for top_level_key, top_level_value in facets.items() %}
        <li>
            <details data-id="{{ top_level_key }}">
                <summary>
                    {{ top_level_value['label'] }}
                </summary>
                {{ parse_facets(top_level_key, top_level_value['content']) }}
            </details>
        </li>
        {% endfor %}
        <li>
            <details>
                <summary data-id="date_search">
                    {{ translate('Search date') }}
                </summary>
                {{ parse_date_form() }}
            </details>
        </li>
    </ul>
</div>
{% endmacro %}

{% macro parse_search_form() %}
<form id="search" method="GET" action="{{ url_for('records_search')}}">
    {% for key, value in query_params if key not in ['start'] %}
    <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
    <input type="text" name="q" placeholder="{{ translate('Search') }}" aria-label="{{ translate('search') }}"
        value="{{ q }}">
    <button type="submit" class="contrast">{{ translate('Search') }}</button>
</form>
{% endmacro %}

{% macro parse_search_title(result) %}
{% if result.label %}
<div class="summary">{{ result.label|truncate(truncate_summary) }}</div>
{% endif %}
{% if result.summary %}
<div class="summary">{{ result.summary|truncate(truncate_summary) }}</div>
{% endif %}
{% endmacro %}

{% macro parse_record_content(label, content) %}
{% if content %}
<div class="record-content">
    <div class="label">
        <strong>{{ label }}</strong>
    </div>
    <div class="search-content">
        {{ content }}
    </div>
</div>
{% endif %}
{% endmacro %}

{% macro pagination_total(pagination_data) %}
{% set total = pagination_data["total"] %}
<div class="pagination-total">
    {% if total == 0 %}
    {{ translate('No search results') }}
    {% elif total == 1 %}
    {{ total }} {{ translate('Search result') }}
    {% elif total == 10000 %}
    {{ translate('More than 10.000 search results') }}
    {% else %}
    {{ total }} {{ translate('Search results') }}
    {% endif %}
</div>
{% endmacro %}

{% macro parse_pagination (pagination_data) %}

{% set total = pagination_data["total"] %}
{% set size = pagination_data["size"] %}
{% set start = pagination_data["start"] %}
{% set total_pages = pagination_data["total_pages"] %}
{% set current_page = pagination_data["current_page"] %}

<div class="pagination">

    <div class="pagination-pages">
        {% if current_page > 1 %}
        <a href="{{ search_base_url }}?{{ query_str }}start=0&size={{ size }}">{{ translate('First page') }}</a>
        <a href="{{ search_base_url }}?{{ query_str }}start={{ start - size }}&size={{ size }}">{{ translate('Previous')
            }}</a>
        {% else %}
        <span class="disabled">{{ translate('First page') }}</span>
        <span class="disabled">{{ translate('Previous') }}</span>
        {% endif %}
        {% if current_page < total_pages %} <a
            href="{{ search_base_url }}?{{ query_str }}start={{ start + size }}&size={{ size }}">{{
            translate('Next')}}</a>
            <a href="{{ search_base_url }}?{{ query_str }}start={{ (total_pages - 1) * size }}&size={{ size }}">{{ translate('Last page') }}</a>
        {% else %}
            <span class="disabled">{{ translate('Next') }}</span>
            <span class="disabled">{{ translate('Last page') }}</span>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro parse_search_results(records) %}
<div class="search-results">
    {% for result in records.result %}
    {% set serie = None %}
    {% if result.series is iterable %}
    {% set serie = result.series | last %}
    {% endif %}

    <div class="search-result">
        <a class="search-link" href="/records/{{ result.id }}">

            {{ parse_search_title(result) }}
            {{ parse_record_content('Skaber', result.collectors_label) }}
            {% if serie %}
            {{ parse_record_content('Serie', serie) }}
            {% endif %}
        </a>
    </div>
    {% endfor %}
</div>
{% endmacro %}

{% macro parse_date_form () %}
<div class="search-date">
    <form id="search-date">
        {% set ignore_keys = ['date_to', 'date_from'] %}
        {% for key, value in query_params if key not in ignore_keys %}
        <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endfor %}
        <label for="from-year" title="{{ translate('The date shall be between 1200 and the current date')}}">{{
            translate('Date From') }}</label><br />
        <input type="text" maxlength="4" id="from-year" name="from-year" placeholder="1600"
            value="{{ dates['from_year']}}">
        <input type="text" maxlength="2" id="from-month" name="from-month" placeholder="01"
            value="{{ dates['from_month']}}">
        <input type="text" maxlength="2" id="from-day" name="from-day" placeholder="01" value="{{ dates['from_day']}}">
        <br>
        <label for="to-year" title="{{ translate('The date shall be between 1200 and the current date')}}">{{
            translate('Date To') }}</label><br />
        <input type="text" maxlength="4" id="to-year" name="to-year" placeholder="2020" value="{{ dates['to_year']}}">
        <input type="text" maxlength="2" id="to-month" name="to-month" placeholder="12" value="{{ dates['to_month']}}">
        <input type="text" maxlength="2" id="to-day" name="to-day" placeholder="31" value="{{ dates['to_day']}}">
        <br>
        <input type="submit" value="{{ translate('Search') }}">
    </form>
</div>
{% endmacro %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/search.css') }}?v={{ get_setting('version') }}">
{% endblock head %}

{% block content %}

<div class="container-fluid">
    <div class="container-left">
        {{ parse_top_level_facets(facets) }}
    </div>
    <div class="container-main-center">
    {{ parse_search_form() }}
    {{ parse_facets_filters(facets_filters) }}
    {{ pagination_total(pagination_data) }}
    {{ parse_pagination(pagination_data) }}
    {{ parse_search_results(records) }}
    {% if pagination_data["total"] > pagination_data["size"] * pagination_data["current_page"] %}
    {{ parse_pagination(pagination_data) }}
    {% endif %}
    </div>
</div>

<script type="module">
    import { searchEvents } from "/static/js/search.js";
    searchEvents();
</script>

{% endblock content %}