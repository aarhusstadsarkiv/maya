{% extends "base.html" %}

{% set truncate_summary = 300 %}
{% set search_base_url = "/records-search" %}

{% macro parse_facets_filters(facets_filters) %}
<ul>
    {% for facet in facets_filters %}
    <li>
        <a class="remove" href="{{ search_base_url }}?{{ facet['remove_query'] }}">{{ translate('Remove facet') }}</a> <span>{{ facet['alter_label'] }}</span>
    </li>
    {% endfor %}
</ul>
{% endmacro %}

{% macro parse_facet_link(top_level_key, facet) %}
{% if facet["checked"] %}
{{ facet['label'] }} ({{ facet["count"] }}) <span class="disabled">({{ translate('Selected') }})</span>
{% elif facet["count"] == 0 %}
{{ facet['label'] }} ({{ facet["count"] }}) <span class="disabled"></span>
{% else %}
<a href="{{ search_base_url }}?{{ facet['search_query'] }}">{{ facet['label'] }} ({{ facet["count"] }})</a>
{% endif %}
{% endmacro %}

{% macro parse_facets(top_level_key, facets_content) %}
<ul>
    {% for facet in facets_content %}
    <li>
        {% if 'children' in facet and facet["count"] %}
        <details>
            <summary>
                {{ parse_facet_link(top_level_key, facet) }}
            </summary>
            {{ parse_facets(top_level_key, facet['children'] ) }}
        </details>
        {% else %}
        {{ parse_facet_link(top_level_key, facet) }}
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endmacro %}

{% macro parse_top_level_facets(facets) %}
<div class="facets">
    <ul>
        {% for top_level_key, top_level_value in facets.items() %}
        <li>
            <details>
                <summary>
                    {{ top_level_value['label'] }}
                </summary>
                {{ parse_facets(top_level_key, top_level_value['content']) }}
            </details>
        </li>
        {% endfor %}
    </ul>
</div>
{% endmacro %}

{% macro parse_search_form() %}
<form method="GET" action="{{ url_for('records_search')}}">
    {% for key, value in query_params %}
    <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
    <input type="text" name="q" placeholder="{{ translate('Search') }}" aria-label="{{ translate('search') }}"
        value="{{ q }}">
    <button type="submit" class="contrast">{{ translate('Search') }}</button>
</form>
{% endmacro %}

{% macro parse_search_title(result) %}
{% if result.label %}
<div class="summary">{{ result.label|truncate(truncate_summary) }}</div>
{% endif %}
{% if result.summary %}
<div class="summary">{{ result.summary|truncate(truncate_summary) }}</div>
{% endif %}
{% endmacro %}

{% macro parse_record_content(label, content) %}
{% if content %}
<div class="record-content" style="padding-top: 0.2em; margin-bottom: 0.2em">
    <div class="label" style="width: 6em;">
        <strong>{{ label }}</strong>
    </div>
    <div class="search-content">
        {{ content }}
    </div>
</div>
{% endif %}
{% endmacro %}

{% macro parse_pagination (pagination_data) %}

{% set total = pagination_data["total"] %}
{% set size = pagination_data["size"] %}
{% set start = pagination_data["start"] %}
{% set total_pages = pagination_data["total_pages"] %}
{% set current_page = pagination_data["current_page"] %}


<div class="pagination">

    <div class="pagination-total">
        {% if total == 0 %}
        {{ translate('No search results') }}
        {% elif total == 1 %}
        {{ total }} {{ translate('Search result') }}
        {% elif total == 10000 %}
        {{ translate('More than 10.000 search results') }}
        {% else %}
        {{ total }} {{ translate('Search results') }}
        {% endif %}
    </div>

    <div class="pagination-pages">
        {% if current_page > 1 %}
        <a href="{{ search_base_url }}?{{ query_str }}&start=0&size={{ size }}">{{ translate('First page') }}</a>
        <a href="{{ search_base_url }}?{{ query_str }}&start={{ start - size }}&size={{ size }}">{{ translate('Previous') }}</a>
        {% else %}
        <span class="disabled">{{ translate('First page') }}</span>
        <span class="disabled">{{ translate('Previous') }}</span>
        {% endif %}
        {% if current_page < total_pages %}
        <a href="{{ search_base_url }}?{{ query_str }}&start={{ start + size }}&size={{ size }}">{{ translate('Next')}}</a>
        <a href="{{ search_base_url }}?{{ query_str }}&start={{ (total_pages - 1) * size }}&size={{ size }}">{{ translate('Last page') }}</a>
        {% else %}
        <span class="disabled">{{ translate('Next') }}</span>
        <span class="disabled">{{ translate('Last page') }}</span>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro parse_search_results(records) %}
<div class="search-results">
    {% for result in records.result %}
    {% set serie = None %}
    {% if result.series is iterable %}
    {% set serie = result.series | last %}
    {% endif %}

    <div class="search-result">
        <a class="search-link" href="/records/{{ result.id }}">

            {{ parse_search_title(result) }}
            {{ parse_record_content('Skaber', result.collectors_label) }}
            {% if serie %}
            {{ parse_record_content('Serie', serie) }}
            {% endif %}
        </a>
    </div>
    {% endfor %}
</div>
{% endmacro %}
{% block head %}
<script src="{{ url_for('static', path='/js/search.js') }}?v={{ get_setting('version') }}"></script>
{% endblock head %}
{% block content %}

{{ parse_search_form() }}
{{ parse_facets_filters(facets_filters) }}
{{ parse_top_level_facets(facets) }}
{{ parse_pagination(pagination_data) }}
{{ parse_search_results(records) }}

<pre>
    {{ to_json(records) }}
</pre>

<style>
    .remove {
        color: var(--flash-error-color);
    }

    .pagination {
        border: 1px darkblue solid;
        padding: 10px;
    
    }
</style>

{% endblock content %}