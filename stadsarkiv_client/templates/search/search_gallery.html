{% extends "search.html" %}

{% set truncate_summary = 160 %}
{% import "macros/common_macros.html" as common_macros %}
{% import "macros/search_macros.html" as search_macros with context %}

{% macro parse_search_title_short(result) %}
{% if result.label %}
<div class="search-summary-gallery">{{ result.label|truncate(truncate_summary) }}</div>
{% else %}
<div class="search-summary-gallery">{{ result.summary|truncate(truncate_summary) }}</div>
{% endif %}
{% endmacro %}

{% macro parse_search_title(result) %}
{% if result.label %}
<div class="search-summary-gallery">{{ result.label|truncate(truncate_summary) }}</div>
{% endif %}
{% if result.summary %}
<div class="search-summary-gallery">{{ result.summary|truncate(truncate_summary) }}</div>
{% endif %}
{% endmacro %}

{% macro parse_search_result_gallery(search_result) %}
{% set start = search_result["start"]|int %}
{% set size = search_result["size"]|int %}

<div class="search-results-gallery">
    {% for result in search_result.result %}
    {% set serie = None %}
    {% if result.series is iterable %}
    {% set serie = result.series | last %}
    {% endif %}
    {% set current = loop.index + start %}

    <div class="search-result-gallery">
        <a class="search-link-gallery" href="/records/{{ result.id }}?search={{ current }}">

            {% if result.portrait %}
            <div class="search-portrait-gallery">
                <img src="{{ result.portrait }}" alt="{{ result.label }}">
            </div>
            {% endif %}
            {{ parse_search_title_short(result) }}
            <div class="search-result-date-gallery">
                {{ result.date_normalized }}
            </div>
        </a>
    </div>
    {% endfor %}
</div>

{% endmacro %}

{% block body_class %}page-records-search{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/search.css') }}?v={{ get_setting('version') }}">
{% endblock head %}

{% block content %}
<div class="container-left">
    {{ search_macros.parse_top_level_facets(facets, "facets", "search-date") }}
</div>
<div class="container-main">

    {% include "includes/flash.html" %}

    {{ search_macros.parse_search() }}
    {{ search_macros.parse_facets_filters(facets_filters) }}
    <div class="container-main-facets">
        {{ search_macros.parse_top_level_facets(facets, 'facets', 'search-date-main') }}
    </div>
    {{ search_macros.parse_pagination_total(pagination_data) }}
    {{ search_macros.parse_pagination(pagination_data) }}
    {{ parse_search_result_gallery(search_result) }}
    {% if pagination_data["total_pages"] != 1 %}
    {{ search_macros.parse_pagination(pagination_data) }}
    {% endif %}
    {% if get_setting('debug') %}

    {% set meta_links = [
    {'label': 'JSON', 'url': url_for('proxies_search_get_json') ~ "?" ~ query_str_search | string}
    ] %}

    {{ common_macros.parse_meta_block(meta_links) }}

    {% endif %}
</div>

<script type="module">
    import { searchEvents } from "/static/js/search.js";
    import { autoCompleteInit } from '/static/js/auto-complete-instance.js';

    searchEvents();

    const searchBaseUrl = '/search?{{ query_str_display }}';
    window.addEventListener("pageshow", function (event) {
        autoCompleteInit(searchBaseUrl);
    });
</script>

{% endblock content %}