{% set image_items = [
{
"image_src": "/assets/udforsk/jul.jpg",
"alt_text": "Jul og Salling",
"link_url": "/search?events=123178",
"link_text": "Jul og Salling"
},
{
"image_src": "/assets/udforsk/jubilæum.jpg",
"alt_text": "Jubilæer",
"link_url": "/search?collection_tags=Jubilæer",
"link_text": "Jubilæer"
},
{
"image_src": "/assets/udforsk/herman_salling.jpg",
"alt_text": "Herman Salling",
"link_url": "/search?people=107435",
"link_text": "Herman Salling"
},
{
"image_src": "/assets/udforsk/folkekultur.jpg",
"alt_text": "Folkekultur og dagligdagsliv",
"link_url": "/search?subjects=33",
"link_text": "Folkekultur og dagligdagsliv"
},
{
"image_src": "/assets/udforsk/ferdinand_salling.jpg",
"alt_text": "Ferdinand Salling",
"link_url": "/search?people=108280",
"link_text": "Ferdinand Salling"
},
{
"image_src": "/assets/udforsk/konfirmation.jpg",
"alt_text": "Konfirmationer",
"link_url": "/search?collection_tags=Konfirmation",
"link_text": "Konfirmationer"
},
{
"image_src": "/assets/udforsk/ejendomme.jpg",
"alt_text": "Ejendomme og bygningsværker",
"link_url": "/search?subjects=10",
"link_text": "Ejendomme og bygningsværker"
}
] %}

<style>
    .image-container {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding: 10px;
        touch-action: none;
        user-select: none;
        padding: 10px 0;
    }

    .image-container::-webkit-scrollbar {
        display: none;
    }

    .image-item {
        position: relative;
        flex-shrink: 0;
        width: 250px;
        height: 150px;
        cursor: grab;
    }

    .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .overlay-text {
        position: absolute;
        bottom: 0;
        color: white;
        font-size: 20px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        background-color: rgba(255, 255, 255, 0.5);
        padding-left: 10px;
        width: 100%;
        cursor: pointer;
    }

    .overlay-text a {
        color: white;
        text-decoration: none;
    }

    .horizontal-slider {
        position: relative;
        /* Ensure the slider is positioned relative */
        width: 100%;
        /* Adjust as needed */
    }

    .horizontal-slider .arrow-left-container,
    .horizontal-slider .arrow-right-container {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: var(--background-disabled);
        z-index: 10;
        cursor: pointer;
        height: 40px;
        width: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .horizontal-slider .arrow-left-container {
        left: 0px;
    }

    .horizontal-slider .arrow-right-container {
        right: 0px;
    }

    .arrow-left-container[disabled], .arrow-right-container[disabled] {
        background-color: var(--background-disabled);
        pointer-events: not-allowed;
        cursor: not-allowed;
    }
</style>

<h3 class="main-title">Populære temaer fra arkivet</h3>

<div class="horizontal-slider">
    <div class="arrow-left-container">
        <svg class="arrow-left" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
            fill="#1f1f1f">
            <path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z" />
        </svg>
    </div>

    <div class="image-container">
        {% for item in image_items %}
        <a href="{{ item.link_url }}">
            <div class="image-item">
                <img src="{{ url_for('static', path=item.image_src) }}" alt="{{ item.alt_text }}">
                <div class="overlay-text">
                    {{ item.link_text }}
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    <div class="arrow-right-container">
        <svg class="arrow-right" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
            fill="#1f1f1f">
            <path d="m321-80-71-71 329-329-329-329 71-71 400 400L321-80Z" />
        </svg>
    </div>
</div>

<script>

    const imageContainer = document.querySelector(".image-container");
    const images = Array.from(document.querySelectorAll(".image-item"));

    function getVisibleImageIndexes() {
        let containerRect = imageContainer.getBoundingClientRect();
        let visibleIndexes = [];

        images.forEach((img, index) => {
            let imgRect = img.getBoundingClientRect();
            let visibleWidth = Math.min(imgRect.right, containerRect.right) - Math.max(imgRect.left, containerRect.left);
            let visibilityRatio = visibleWidth / imgRect.width;

            if (visibilityRatio >= 1) {
                visibleIndexes.push(index);
            }
        });

        return visibleIndexes;
    }

    function scrollByImage(direction) {
        let visibleIndexes = getVisibleImageIndexes();
        let targetIndex;

        // Determine which image to scroll to next
        if (direction === "left") {
            targetIndex = visibleIndexes[0] - 1; // Move to the leftmost previous image
        } else {
            // Scroll to the next image to the right
            targetIndex = visibleIndexes[visibleIndexes.length - 1] + 1;
        }

        // Ensure that the targetIndex is within valid bounds
        if (targetIndex >= 0 && targetIndex < images.length) {
            let target = images[targetIndex];
            console.log(target)

            if (direction === "left") {
                imageContainer.scrollTo({
                    left: target.offsetLeft - imageContainer.offsetLeft,
                    behavior: 'smooth'
                });
            } else {
                imageContainer.scrollTo({
                    left: target.offsetLeft + target.offsetWidth - imageContainer.offsetWidth,
                    behavior: 'smooth'
                });
            }
        }
    }

    function setDisabled () {

        // wait for the scroll to finish
        setTimeout(() => {
            // Set initial disabled on 'arrow-right-container' if first image is visible
            if (getVisibleImageIndexes().includes(0)) {
                document.querySelector(".arrow-left-container").setAttribute("disabled", "");
            } else {
                document.querySelector(".arrow-left-container").removeAttribute("disabled");
            }

            // Set initial disabled on 'arrow-right-container' if last image is visible
            if (getVisibleImageIndexes().includes(images.length - 1)) {
                document.querySelector(".arrow-right-container").setAttribute("disabled", "");
            } else {
                document.querySelector(".arrow-right-container").removeAttribute("disabled");
            }
        }, 500);
        
        /*
        console.log(getVisibleImageIndexes())
        // Set initial disabled on 'arrow-right-container' if first image is visible
        if (getVisibleImageIndexes().includes(0)) {
            document.querySelector(".arrow-left-container").setAttribute("disabled", "");
        } else {
            document.querySelector(".arrow-left-container").removeAttribute("disabled");
        }

        // Set initial disabled on 'arrow-right-container' if last image is visible
        if (getVisibleImageIndexes().includes(images.length - 1)) {
            document.querySelector(".arrow-right-container").setAttribute("disabled", "");
        } else {
            document.querySelector(".arrow-right-container").removeAttribute("disabled");
        }*/
    }

    document.querySelector(".arrow-left-container").addEventListener("click", () => {
        scrollByImage("left");
        console.log("Scrolling left done" )
        setDisabled();
    });

    document.querySelector(".arrow-right-container").addEventListener("click", () => {
        scrollByImage("right");
        setDisabled();
    });

    setDisabled();

    const pointerScroll = (elem) => {
        let clickedElement = null;
        let isDragging = false;
        let startX = 0;

        const dragStart = (ev) => {
            elem.setPointerCapture(ev.pointerId);
            startX = ev.clientX;
            isDragging = false;
            clickedElement = ev.target; // Store the initially clicked element
            ev.preventDefault(); // Prevent default image dragging
        };

        const dragEnd = (ev) => {
            elem.releasePointerCapture(ev.pointerId);

            if (!isDragging && clickedElement) {
                let target = clickedElement;

                // Traverse up to find the closest <a> element
                while (target && target.tagName !== "A") {
                    target = target.parentElement;
                }

                if (target && target.tagName === "A") {
                    window.location.href = target.href;
                }
            }
        };

        const drag = (ev) => {
            if (elem.hasPointerCapture(ev.pointerId)) {
                if (Math.abs(ev.clientX - startX) > 5) {
                    isDragging = true;
                }
                elem.scrollLeft -= ev.movementX;
            }
        };

        const preventClickOnDrag = (ev) => {
            if (isDragging) {
                ev.stopPropagation();
                ev.preventDefault(); // Prevent click from triggering navigation
            }
        };

        elem.addEventListener("pointerdown", dragStart);
        elem.addEventListener("pointerup", dragEnd);
        elem.addEventListener("pointermove", drag);
        elem.addEventListener("click", preventClickOnDrag, true); // Capture click events

    };

    document.querySelectorAll(".image-container").forEach(pointerScroll);

</script>